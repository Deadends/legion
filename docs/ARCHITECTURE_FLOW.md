# Legion ZK Auth - Complete Architecture Flow ğŸ”

## ğŸ¯ True Zero-Knowledge Authentication Flow

This document provides a detailed, step-by-step visualization of how Legion implements true zero-knowledge authentication with hardware-bound device signatures.

---

## ğŸ“Š Complete Authentication Flow

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     LEGION ZK AUTHENTICATION FLOW                        â•‘
â•‘                  (True Zero-Knowledge with Hardware Binding)             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CLIENT (Browser/WASM)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  STEP 1: CREDENTIAL HASHING (Client-Side)                  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Input: username = "alice"                               â”‚
    â”‚         password = "secret123"                           â”‚
    â”‚                                                          â”‚
    â”‚  Compute:                                                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ username_hash = Blake3("alice")                   â”‚   â”‚
    â”‚  â”‚ â†’ 32 bytes (fast, collision-resistant)            â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                                                          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ password_hash = Argon2id("secret123")             â”‚   â”‚
    â”‚  â”‚ â†’ 32 bytes (memory-hard, GPU-resistant)           â”‚   â”‚
    â”‚  â”‚ â†’ Time: ~100ms, Memory: 64MB                      â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                                                          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ credential_hash = username_hash || password_hash  â”‚   â”‚
    â”‚  â”‚ â†’ 64 bytes total                                  â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  STEP 2: REQUEST MERKLE PATH (Client â†’ Server)             â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â”‚
                                 â–¼
         POST /auth/challenge {username_hash}
                                 â”‚
                                 â”‚ HTTPS/TLS 1.3
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SERVER (Rust/Axum)                             â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. Lookup user in Merkle tree (2^20 capacity)                    â”‚   â”‚
â”‚  â”‚    â†’ Find leaf position for username_hash                        â”‚   â”‚
â”‚  â”‚    â†’ Extract authentication path (20 siblings)                   â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚ 2. Generate random challenge                                     â”‚   â”‚
â”‚  â”‚    â†’ challenge = random_bytes(32)                                â”‚   â”‚
â”‚  â”‚    â†’ Store in Redis with 5-minute TTL                            â”‚   â”‚
â”‚  â”‚    â†’ Key: username_hash â†’ Value: challenge                       â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚ 3. Fetch device tree root                                        â”‚   â”‚
â”‚  â”‚    â†’ device_merkle_root (2^10 devices per user)                  â”‚   â”‚
â”‚  â”‚    â†’ Initially empty for new users                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚
                                 â–¼
         Response: {
           merkle_path: [sibling_0, ..., sibling_19],
           merkle_root: root_hash,
           challenge: random_32_bytes,
           device_merkle_root: device_root
         }
                                 â”‚
                                 â”‚ HTTPS/TLS 1.3
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CLIENT (Browser/WASM)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  STEP 3: WEBAUTHN KEY GENERATION (Hardware-Bound)          â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Trigger WebAuthn API (Level 2)                          â”‚
    â”‚                                                          â”‚
    â”‚  navigator.credentials.create({                          â”‚
    â”‚    publicKey: {                                          â”‚
    â”‚      challenge: server_challenge,                        â”‚
    â”‚      rp: {name: "Legion ZK Auth"},                       â”‚
    â”‚      user: {id: username_hash, name: "anonymous"},       â”‚
    â”‚      pubKeyCredParams: [{alg: -7, type: "public-key"}],  â”‚
    â”‚      authenticatorSelection: {                           â”‚
    â”‚        authenticatorAttachment: "platform",              â”‚
    â”‚        userVerification: "required"                      â”‚
    â”‚      }                                                   â”‚
    â”‚    }                                                     â”‚
    â”‚  })                                                      â”‚
    â”‚                                                          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ Hardware Security Module (TPM/Secure Enclave)     â”‚   â”‚
    â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚
    â”‚  â”‚ â€¢ User gesture required (touch/biometric)         â”‚   â”‚
    â”‚  â”‚ â€¢ Generate/retrieve ECDSA P-256 key pair          â”‚   â”‚
    â”‚  â”‚ â€¢ Private key NEVER leaves hardware               â”‚   â”‚
    â”‚  â”‚ â€¢ Returns: device_pubkey (33 bytes compressed)    â”‚   â”‚
    â”‚  â”‚ â€¢ Attestation: Proves genuine hardware            â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                                                          â”‚
    â”‚  Output: device_pubkey = 0x02... (33 bytes)              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  STEP 4: NULLIFIER COMPUTATION (Replay Protection)         â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Compute nullifier (unique per auth attempt)             â”‚
    â”‚                                                          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ nullifier = Poseidon(credential_hash || challenge)â”‚   â”‚
    â”‚  â”‚                                                   â”‚   â”‚
    â”‚  â”‚ Why Poseidon?                                     â”‚   â”‚
    â”‚  â”‚ â€¢ ZK-friendly hash (efficient in circuits)        â”‚   â”‚
    â”‚  â”‚ â€¢ 128-bit security                                â”‚   â”‚
    â”‚  â”‚ â€¢ Deterministic (same inputs â†’ same output)       â”‚   â”‚
    â”‚  â”‚                                                   â”‚   â”‚
    â”‚  â”‚ Properties:                                       â”‚   â”‚
    â”‚  â”‚ âœ“ Unique per challenge (prevents replay)          â”‚   â”‚
    â”‚  â”‚ âœ“ Binds credential to this auth session           â”‚   â”‚
    â”‚  â”‚ âœ“ Cannot be reversed to get credentials           â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                                                          â”‚
    â”‚  Check: Has this nullifier been used before?             â”‚
    â”‚  â†’ Query server's nullifier database                     â”‚
    â”‚  â†’ If exists: ABORT (replay attack detected)             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  STEP 5: LINKABILITY TAG (Session Binding)                 â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Compute linkability tag (prevents session theft)        â”‚
    â”‚                                                          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ linkability_tag = Blake3(device_pubkey ||          â”‚  â”‚
    â”‚  â”‚                          nullifier)                â”‚  â”‚
    â”‚  â”‚                                                    â”‚  â”‚
    â”‚  â”‚ Critical Security Property:                        â”‚  â”‚
    â”‚  â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â”‚  â”‚
    â”‚  â”‚ â€¢ Binds session to SPECIFIC device + user          â”‚  â”‚
    â”‚  â”‚ â€¢ Attacker cannot steal session token because:     â”‚  â”‚
    â”‚  â”‚   â†’ They don't have device_pubkey (in hardware)    â”‚  â”‚
    â”‚  â”‚   â†’ Cannot recompute linkability_tag               â”‚  â”‚
    â”‚  â”‚   â†’ Server rejects mismatched tags                 â”‚  â”‚
    â”‚  â”‚                                                    â”‚  â”‚
    â”‚  â”‚ â€¢ Maintains zero-knowledge:                        â”‚  â”‚
    â”‚  â”‚   â†’ Server sees tag but not identity               â”‚  â”‚
    â”‚  â”‚   â†’ Same tag for entire session (linkable)         â”‚  â”‚
    â”‚  â”‚   â†’ Different tag per auth (unlinkable across)     â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  STEP 6: ZK PROOF GENERATION (Halo2 PLONK Circuit)         â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Generate zero-knowledge proof (~4 minutes for k=16)     â”‚
    â”‚                                                          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ CIRCUIT INPUTS (Private Witnesses)                â”‚   â”‚
    â”‚  â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                â”‚   â”‚
    â”‚  â”‚ â€¢ credential_hash (64 bytes) - PRIVATE            â”‚   â”‚
    â”‚  â”‚ â€¢ merkle_path (20 siblings) - PRIVATE             â”‚   â”‚
    â”‚  â”‚ â€¢ leaf_index (position in tree) - PRIVATE         â”‚   â”‚
    â”‚  â”‚ â€¢ device_pubkey (33 bytes) - PRIVATE              â”‚   â”‚
    â”‚  â”‚ â€¢ device_path (10 siblings) - PRIVATE             â”‚   â”‚
    â”‚  â”‚ â€¢ device_index - PRIVATE                          â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                                                          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ CIRCUIT OUTPUTS (Public Inputs)                   â”‚   â”‚
    â”‚  â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                  â”‚   â”‚
    â”‚  â”‚ â€¢ merkle_root (user tree) - PUBLIC                â”‚   â”‚
    â”‚  â”‚ â€¢ device_merkle_root - PUBLIC                     â”‚   â”‚
    â”‚  â”‚ â€¢ nullifier - PUBLIC                              â”‚   â”‚
    â”‚  â”‚ â€¢ challenge - PUBLIC                              â”‚   â”‚
    â”‚  â”‚ â€¢ timestamp - PUBLIC                              â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                                                          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ CIRCUIT CONSTRAINTS (What We Prove)               â”‚   â”‚
    â”‚  â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•              â”‚   â”‚
    â”‚  â”‚                                                   â”‚   â”‚
    â”‚  â”‚ 1. Merkle Tree Membership (User Anonymity)        â”‚   â”‚
    â”‚  â”‚    âœ“ credential_hash is leaf in tree              â”‚  â”‚
    â”‚  â”‚    âœ“ Path verification: leaf â†’ root               â”‚  â”‚
    â”‚  â”‚    âœ“ Root matches public merkle_root              â”‚  â”‚
    â”‚  â”‚    âœ— Leaf position HIDDEN (1 of 2^20)             â”‚  â”‚
    â”‚  â”‚                                                   â”‚   â”‚
    â”‚  â”‚ 2. Device Tree Membership (Device Anonymity)      â”‚   â”‚
    â”‚  â”‚    âœ“ device_pubkey is leaf in device tree         â”‚  â”‚
    â”‚  â”‚    âœ“ Path verification: device â†’ root             â”‚  â”‚
    â”‚  â”‚    âœ“ Root matches public device_merkle_root       â”‚  â”‚
    â”‚  â”‚    âœ— Device position HIDDEN (1 of 2^10)           â”‚  â”‚
    â”‚  â”‚                                                   â”‚  â”‚
    â”‚  â”‚ 3. Nullifier Correctness                          â”‚  â”‚
    â”‚  â”‚    âœ“ nullifier = Poseidon(credential_hash ||      â”‚  â”‚
    â”‚  â”‚                           challenge)              â”‚  â”‚
    â”‚  â”‚    âœ“ Binds proof to specific challenge            â”‚  â”‚
    â”‚  â”‚                                                   â”‚  â”‚
    â”‚  â”‚ 4. Credential Hash Integrity                      â”‚  â”‚
    â”‚  â”‚    âœ“ credential_hash properly formatted           â”‚  â”‚
    â”‚  â”‚    âœ“ Matches stored hash in Merkle tree           â”‚  â”‚
    â”‚  â”‚                                                   â”‚  â”‚
    â”‚  â”‚ 5. Timestamp Freshness                            â”‚  â”‚
    â”‚  â”‚    âœ“ timestamp = current_time (Unix epoch)        â”‚  â”‚
    â”‚  â”‚    âœ“ Prevents old proof replay                    â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ PROOF OUTPUT (Halo2 PLONK)                        â”‚  â”‚
    â”‚  â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â”‚  â”‚
    â”‚  â”‚ â€¢ Proof size: ~3.5 KB (k=16)                      â”‚  â”‚
    â”‚  â”‚ â€¢ Generation time: ~4 minutes                     â”‚  â”‚
    â”‚  â”‚ â€¢ Verification time: ~10ms                        â”‚  â”‚
    â”‚  â”‚ â€¢ Security: 2^-128 soundness error                â”‚  â”‚
    â”‚  â”‚ â€¢ No trusted setup required                       â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  STEP 7: PROOF SUBMISSION (Client â†’ Server)                â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â”‚
                                 â–¼
         POST /auth/verify {
           proof: bytes,
           public_inputs: {
             merkle_root,
             device_merkle_root,
             nullifier,
             challenge,
             timestamp
           },
           linkability_tag: bytes
         }
                                 â”‚
                                 â”‚ HTTPS/TLS 1.3
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SERVER (Rust/Axum)                            â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ VERIFICATION STEPS (All Must Pass)                               â”‚  â”‚
â”‚  â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                            â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚ 1. Timestamp Validation                                          â”‚  â”‚
â”‚  â”‚    âœ“ |proof_timestamp - server_time| < 5 minutes                 â”‚  â”‚
â”‚  â”‚    âœ— Reject if too old (replay protection)                       â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚ 2. Challenge Verification                                        â”‚  â”‚
â”‚  â”‚    âœ“ Lookup challenge in Redis by username_hash                  â”‚  â”‚
â”‚  â”‚    âœ“ Verify challenge matches proof's public input               â”‚  â”‚
â”‚  â”‚    âœ“ Delete challenge (one-time use)                             â”‚  â”‚
â”‚  â”‚    âœ— Reject if challenge not found or mismatched                 â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚ 3. Nullifier Check (Replay Protection)                           â”‚  â”‚
â”‚  â”‚    âœ“ Query RocksDB: Has nullifier been used?                     â”‚  â”‚
â”‚  â”‚    âœ— If YES: REJECT (replay attack)                              â”‚  â”‚
â”‚  â”‚    âœ“ If NO: Continue verification                                â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚ 4. Merkle Root Validation                                        â”‚  â”‚
â”‚  â”‚    âœ“ Verify merkle_root matches current tree root                â”‚  â”‚
â”‚  â”‚    âœ“ Verify device_merkle_root matches user's device tree        â”‚  â”‚
â”‚  â”‚    âœ— Reject if roots don't match                                 â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚ 5. ZK Proof Verification (Halo2)                                 â”‚  â”‚
â”‚  â”‚    âœ“ Verify proof against public inputs                          â”‚  â”‚
â”‚  â”‚    âœ“ Check all circuit constraints satisfied                     â”‚  â”‚
â”‚  â”‚    âœ“ Verification time: ~10ms                                    â”‚  â”‚
â”‚  â”‚    âœ— Reject if proof invalid                                     â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚ 6. Mark Nullifier as Used                                        â”‚  â”‚
â”‚  â”‚    âœ“ Store nullifier in RocksDB (permanent)                      â”‚  â”‚
â”‚  â”‚    âœ“ Cache in Redis (fast lookup)                                â”‚  â”‚
â”‚  â”‚    âœ“ Prevents future replay of this proof                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ SESSION TOKEN GENERATION                                         â”‚  â”‚
â”‚  â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                          â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚ session_token = Poseidon(nullifier ||                            â”‚  â”‚
â”‚  â”‚                          timestamp ||                            â”‚  â”‚
â”‚  â”‚                          linkability_tag)                        â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚ Store in Redis:                                                  â”‚  â”‚
â”‚  â”‚   Key: session_token                                             â”‚  â”‚
â”‚  â”‚   Value: linkability_tag                                         â”‚  â”‚
â”‚  â”‚   TTL: 1 hour (sliding window)                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚
                                 â–¼
         Response: {
           session_token: bytes,
           expires_at: timestamp
         }
                                 â”‚
                                 â”‚ HTTPS/TLS 1.3
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CLIENT (Browser/WASM)                          â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Store session credentials:                                       â”‚   â”‚
â”‚  â”‚ â€¢ session_token â†’ localStorage                                   â”‚   â”‚
â”‚  â”‚ â€¢ linkability_tag â†’ memory (recompute from device_pubkey)        â”‚   â”‚
â”‚  â”‚ â€¢ expires_at â†’ localStorage                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  STEP 8: SESSION VALIDATION (Every Subsequent Request)    â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â”‚
                                 â–¼
         POST /auth/session {
           session_token,
           linkability_tag
         }
                                 â”‚
                                 â”‚ HTTPS/TLS 1.3
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SERVER (Rust/Axum)                             â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ SESSION VALIDATION (Fast - No ZK Proof)                          â”‚   â”‚
â”‚  â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                          â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚ 1. Lookup session in Redis                                       â”‚   â”‚
â”‚  â”‚    âœ“ Key: session_token                                          â”‚   â”‚
â”‚  â”‚    âœ“ Get stored_linkability_tag                                  â”‚   â”‚
â”‚  â”‚    âœ— If not found: Session expired/invalid                       â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚ 2. Verify Linkability Tag                                        â”‚   â”‚
â”‚  â”‚    âœ“ Compare: stored_tag == provided_tag                         â”‚   â”‚
â”‚  â”‚    âœ— If mismatch: SESSION THEFT DETECTED                         â”‚   â”‚
â”‚  â”‚       â†’ Attacker has token but not device key                    â”‚   â”‚
â”‚  â”‚       â†’ Cannot recompute correct linkability_tag                 â”‚   â”‚
â”‚  â”‚       â†’ REJECT request                                           â”‚   â”‚ 
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚ 3. Check Expiration                                              â”‚   â”‚
â”‚  â”‚    âœ“ Verify current_time < expires_at                            â”‚   â”‚
â”‚  â”‚    âœ“ Extend TTL (sliding window)                                 â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚ 4. Return Success                                                â”‚   â”‚
â”‚  â”‚    âœ“ User authenticated (anonymously)                            â”‚   â”‚
â”‚  â”‚    âœ“ Server knows: "valid user" but NOT which user               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
         Response: {
           valid: true,
           user_anonymous: true
         }
                                 â”‚
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CLIENT (Browser/WASM)                          â”‚
â”‚                                                                         â”‚
â”‚  âœ… Authenticated! User can now access protected resources              â”‚
â”‚  ğŸ”’ Server knows user is valid but NOT their identity                   â”‚
â”‚  ğŸ›¡ï¸ Session bound to device (cannot be stolen)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Security Properties Explained

### 1. User Anonymity (1 of 2^20)
```
Server's View:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Merkle Tree (1,048,576 users)                               â”‚
â”‚                                                             â”‚
â”‚     Root: 0xabc123...                                       â”‚
â”‚      /              \                                       â”‚
â”‚    ...              ...                                     â”‚
â”‚   /   \            /   \                                    â”‚
â”‚  ?     ?          ?     ?     â† Server sees tree structure  â”‚
â”‚                                                             â”‚
â”‚ âœ“ Proof shows: "One of these leaves is valid"               â”‚
â”‚ âœ— Proof hides: "Which specific leaf"                        â”‚
â”‚                                                             â”‚
â”‚ Result: Server cannot determine which user authenticated    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Device Anonymity (1 of 2^10)
```
Per-User Device Tree:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Device Tree (1,024 devices per user)                        â”‚
â”‚                                                             â”‚
â”‚     Device Root: 0xdef456...                                â”‚
â”‚      /                    \                                 â”‚
â”‚    ...                    ...                               â”‚
â”‚   /   \                  /   \                              â”‚
â”‚  ?     ?                ?     ?     â† Devices hidden        â”‚
â”‚                                                             â”‚
â”‚ âœ“ Proof shows: "One of user's devices is valid"             â”‚
â”‚ âœ— Proof hides: "Which specific device"                      â”‚
â”‚                                                             â”‚
â”‚ Result: Server cannot link sessions to specific devices     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Nullifier-Based Replay Protection
```
Timeline:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Auth Attempt 1:                                             â”‚
â”‚   challenge_1 â†’ nullifier_1 â†’ âœ… Accepted (first use)       â”‚
â”‚   Server stores: nullifier_1 in RocksDB                     â”‚
â”‚                                                             â”‚
â”‚ Auth Attempt 2 (replay attack):                             â”‚
â”‚   challenge_1 â†’ nullifier_1 â†’ âŒ REJECTED (already used)    â”‚
â”‚   Server checks: nullifier_1 exists â†’ replay detected       â”‚
â”‚                                                             â”‚
â”‚ Auth Attempt 3 (legitimate):                                â”‚
â”‚   challenge_2 â†’ nullifier_2 â†’ âœ… Accepted (new nullifier)   â”‚
â”‚   Server stores: nullifier_2 in RocksDB                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. Linkability Tag Session Binding
```
Scenario: Attacker steals session_token
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Legitimate User:                                            â”‚
â”‚   device_pubkey (in TPM) â†’ linkability_tag_A                â”‚
â”‚   session_token + linkability_tag_A â†’ âœ… Valid              â”‚
â”‚                                                             â”‚
â”‚ Attacker (different device):                                â”‚
â”‚   Stolen: session_token                                     â”‚
â”‚   Missing: device_pubkey (locked in victim's TPM)           â”‚
â”‚   Computes: linkability_tag_B (wrong!)                      â”‚
â”‚   session_token + linkability_tag_B â†’ âŒ REJECTED           â”‚
â”‚                                                             â”‚
â”‚ Server verification:                                        â”‚
â”‚   stored_tag (tag_A) â‰  provided_tag (tag_B)                 â”‚
â”‚   â†’ Session theft detected â†’ Request denied                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Performance Characteristics

| Operation | Time | Notes |
|-----------|------|-------|
| Credential Hashing | ~100ms | Argon2id (client-side) |
| WebAuthn Key Gen | ~1s | User gesture required |
| Nullifier Computation | <1ms | Poseidon hash |
| ZK Proof Generation | ~4min | k=16, client-side |
| Proof Submission | ~50ms | Network + processing |
| Proof Verification | ~10ms | Server-side (fast!) |
| Session Validation | <1ms | Redis lookup only |

---

## ğŸ¯ Zero-Knowledge Guarantees

### What Server Learns âœ…
- Someone in the anonymity set (1 of 1M users) authenticated
- Proof is cryptographically valid (2^-128 soundness)
- Same user+device for session (via linkability tag)
- Nullifier is unique (no replay)

### What Server CANNOT Learn âŒ
- Which specific user (position in Merkle tree hidden)
- Which specific device (position in device tree hidden)
- Username or password (only hashes in circuit)
- Device private key (locked in hardware)
- Any linkage between sessions (different nullifiers)

---

## ğŸ›¡ï¸ Attack Resistance

| Attack Type | Defense Mechanism | Result |
|-------------|-------------------|--------|
| Replay Attack | Nullifier tracking | âŒ Rejected |
| Session Theft | Linkability tag binding | âŒ Rejected |
| Credential Stuffing | Argon2id + rate limiting | âŒ Mitigated |
| Timing Attack | Constant-time circuit ops | âŒ No leakage |
| Proof Forgery | Halo2 soundness (2^-128) | âŒ Infeasible |
| Device Cloning | Hardware attestation | âŒ Detected |
| MitM Attack | TLS 1.3 + certificate pinning | âŒ Prevented |

---

**Built with â¤ï¸ for privacy and security**
